---
editor_options: 
  chunk_output_type: console
---

## Examining changes in relative abundance over time as a function of species habitat affiliation  

In this script, we will examine how relative abundance varies as a function of habitat affiliation across time periods for bird communities. We will plot species rank abundances of relative abundance to estimate how values of relative abundance has shifted for each species. In addition, we will run beta regressions to test for significance in relative abundance changes over time. 

## Load necessary libraries
```{r}
library(dplyr)
library(stringr)
library(tidyverse)
library(scico)
library(RColorBrewer)
library(extrafont)
library(sf)
library(raster)
library(lattice)
library(data.table)
library(ggrepel)
library(report)
library(lme4)
library(glmmTMB)
library(multcomp)
library(ggstatsplot)
library(paletteer)
library(ggpubr)
library(goeveg)
library(sjPlot)
library(patchwork)
```

## Load data on species relative abundances
```{r}
relAbun <- read.csv("results/species-relative-abundance.csv")
names(relAbun) <- c("scientific_name","1850-1900","1900-1950","2021")
```

## Load species trait data  
```{r}
## load in species trait dataset
trait_dat <- read.csv("data/species-trait-dat.csv")

# note: the classification of habitat type was created by comparing habitat affiliation data from the State of India's Birds report (v2; released in 2023). 
# this classification was also vetted independently by two reviewers.
# We used the following trait classifications:
# Forest 
# Grassland 
# Generalist

# Our criteria for each of these classifications includes the following: 
# In the 1850s, the land cover change analysis revealed that the majority of the landscape was largely grasslands and forests. However in 2018, the landscape is largely a mosaic of human-modified land cover types - including wooded habitats (mostly comprising timber plantations and degraded forests), tea plantations, followed by forests and grasslands.
# While the State of India's Birds provides a habitat classification/criteria based on contemporary use of habitats by a species, we classified species based on our resurveys and assuming that a species would either be in a forest affiliated bird species, grassland species or a generalist species in the 1850s. 
# An example in this case is the black and orange flycatcher. While it is commonly found in shola forest habitat, this species is also common in degraded wooded areas, including timber plantations today. However, historically, in the 1850s (due to limited presence of timber plantations compared to 2018), we assume that this is a forest specialist bird as no other wooded habitats apart from forests existed (predominantly) in the 1850s (See 06_land-cover-classification.Rmd)
# Other examples include bird species that prefer open habitats, scrubland and dry grassland - such species have been lumped into the Grassland category as this was the closest habitat similar to the above habitat types in 1850s. Eg. Blue-tailed bee-eater, long-tailed shrike, black-winged kite. 
# If a species is truly a generalist species and is not particularly occupying/specialized on any particular  forested/grassland habitat, it was classified in the generalist category

## join overall relative abundance dataframe and species trait data 
rel_abun_trait <- relAbun %>%
  pivot_longer(-scientific_name, names_to = "time_period", values_to = "relative_abundance") %>% left_join(., trait_dat, by=c("scientific_name"="scientific_name")) %>%
   filter(Habitat.type != "Wetland") %>% # remove wetland birds
  ungroup()

# count distinct number of species affiliated with a particular habitat type
spCount <- rel_abun_trait[,c(1,7)] %>%
  distinct() %>%
  group_by(Habitat.type) %>%
  count()

# Based on the above criteria, 60 species were classified as forest birds, 11 species were classified as grassland birds, 21 species were classified as generalist species.  

# visualization by habitat affiliation
rel_abun_trait$Habitat.type <- factor(rel_abun_trait$Habitat.type, levels=c("Forest", "Grassland", "Generalist"))

fig_relAbun_habitat <- grouped_ggbetweenstats(
  data = rel_abun_trait,
  x = time_period,
  y = relative_abundance,
  grouping.var = `Habitat.type`,
  xlab = "Habitat.type", 
  ylab = "Relative Abundance",
  p.adjust.method = "fdr",
  plot.type = "box") +
  scale_fill_scico_d(palette = "roma") 

ggsave(fig_relAbun_habitat, filename = "figs/fig_relAbun_habitat_landscapeLevel.png", width = 17, height = 7, device = png(), units = "in", dpi = 300)
dev.off()
```

## Visualizing relative abundance change by species across time periods for grassland bird species 

Based on the above statistical analyses, we found that the mean relative abundance of grassland bird species were significantly lower in 2021 compared to the previous two historical time periods. Here, we assess how relative abundance varies by species between the historical and modern time period. 

```{r}
## grassland birds
grassland <- rel_abun_trait %>%
  filter(Habitat.type == "Grassland") %>%
  dplyr::select(scientific_name, time_period, relative_abundance) %>% pivot_wider(., names_from = time_period, values_from = relative_abundance)

# 1850-1900 vs. 2021
fig_grassland_1850v2021 <- ggplot(data=grassland,aes(x=`2021`,y=`1850-1900`)) +
   scale_y_log10() +
  geom_abline(slope=1, intercept=0,linetype="dashed") +
  scale_x_log10() +
  labs(y = "1850-1900 Relative abundance", 
       x = "2021 Relative abundance") +
   geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_text_repel(aes(label = scientific_name),family = "Century Gothic", fontface = "italic")+
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_grassland_1850v2021, filename = "figs/fig_grassland_1850-1900_vs_2021_relAbun.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

# 1900-1950 vs. 2021
fig_grassland_1900v2021 <- ggplot(data=grassland,aes(x=`2021`,y=`1900-1950`)) +
   scale_y_log10() +
  geom_abline(slope=1, intercept=0,linetype="dashed") +
  scale_x_log10() +
  labs(y = "1900-1950 Relative abundance", 
       x = "2021 Relative abundance") +
   geom_point(shape = 21, colour = "black", fill = "white", size = 2, stroke = 1)+
   geom_text_repel(aes(label = scientific_name),family = "Century Gothic", fontface = "italic")+
  theme_bw() +
  theme(axis.text = element_text(family = "Century Gothic", size = 13),
        legend.title = element_text(family = "Century Gothic"),
    legend.text = element_text(family = "Century Gothic"),
    text = element_text(family = "Century Gothic", size = 25))

ggsave(fig_grassland_1900v2021, filename = "figs/fig_grassland_1900-1950_vs_2021_relAbun.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```

## Rank abundance plots of relative abundance by species trait across time periods 
```{r}
# forest birds separately (due to large number of species)
forest_rank <- rel_abun_trait %>%
  filter(Habitat.type == "Forest")

fig_rankAbund_forest <- ggplot(forest_rank, aes(x = reorder(scientific_name,relative_abundance), y = relative_abundance, fill = time_period)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) + scale_fill_manual(values = c("#2c7fb8",'#025a05',"#e34a33")) +
  theme_bw() +
  facet_wrap(~Habitat.type, scales = "free")+
  labs(
    x = "",
    y = "Relative abundance\n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", 
                             size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, 
                               hjust = 1))

ggsave(fig_rankAbund_forest, filename = "figs/fig_rankAbundance_forestBirds.png", width = 32, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

# grassland birds
grass_rank <- rel_abun_trait %>%
  filter(Habitat.type == "Grassland")

fig_rankAbund_grass <- ggplot(grass_rank, aes(x = reorder(scientific_name,relative_abundance), y = relative_abundance, fill = time_period)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) + scale_fill_manual(values = c("#2c7fb8",'#025a05',"#e34a33")) +
  facet_wrap(~Habitat.type, scales = "free", ncol = 2)+
  theme_bw() +
  labs(
    x = "\nScientific name",
    y = "Relative abundance\n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", 
                             size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, 
                               hjust = 1)) 

ggsave(fig_rankAbund_grass, filename = "figs/fig_rankAbundance_grassland.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

# generalist birds
gen_rank <- rel_abun_trait %>%
  filter(Habitat.type == "Generalist")

fig_rankAbund_gen <- ggplot(gen_rank, aes(x = reorder(scientific_name,relative_abundance), y = relative_abundance, fill = time_period)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.5) + scale_fill_manual(values = c("#2c7fb8",'#025a05',"#e34a33")) +
  facet_wrap(~Habitat.type, scales = "free", ncol = 2)+
  theme_bw() +
  labs(
    x = "\nScientific name",
    y = "Relative abundance\n"
  ) +
  theme(
    axis.title = element_text(
      family = "Century Gothic",
      size = 14, face = "bold"
    ),
    axis.text = element_text(family = "Century Gothic", 
                             size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, 
                               hjust = 1)) 

ggsave(fig_rankAbund_gen, filename = "figs/fig_rankAbundance_generalist.png", width = 15, height = 10, device = png(), units = "in", dpi = 300)
dev.off()

## combined plot
p1 <- fig_rankAbund_forest + theme(legend.position = "none")
p2 <- fig_rankAbund_grass + theme(legend.position = "none")

fig_rankAbund <- p1 / (p2 | fig_rankAbund_gen)

ggsave(fig_rankAbund, filename = "figs/fig_rankAbundance.png", width = 33, height = 17, device = png(), units = "in", dpi = 300)
dev.off()

# Grassland birds are the biggest losers; generalist birds are the biggest winners while forest birds show mixed responses depending on the species
```

## Are there significant decreases in relative abundance by time periods across habitat affiliations?

We will run beta regressions to answer the above question as the data is bounded between zero and 1. 
```{r}
beta_overall <- betareg(relative_abundance~ time_period,data = rel_abun_trait)
summary(beta_overall)

# Call:
# betareg(formula = relative_abundance ~ time_period, data = rel_abun_trait)
# 
# Standardized weighted residuals 2:
#     Min      1Q  Median      3Q     Max 
# -1.6108 -0.6158  0.0337  0.5997  2.1658 
# 
# Coefficients (mean model with logit link):
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)          -4.41132    0.09018 -48.919   <2e-16 ***
# time_period1900-1950  0.05346    0.11499   0.465    0.642    
# time_period2021      -0.40120    0.12195  -3.290    0.001 ** 
# 
# Phi coefficients (precision model with identity link):
#       Estimate Std. Error z value Pr(>|z|)    
# (phi)   83.735      8.135   10.29   <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
# 
# Type of estimator: ML (maximum likelihood)
# Log-likelihood:   982 on 4 Df
# Pseudo R-squared: 0.07799
# Number of iterations: 27 (BFGS) + 2 (Fisher scoring) 

# plot predicted model estimates
set_theme(base = theme_bw(),
          theme.font = "Century Gothic",
          axis.title.size = 1.2,
          axis.textsize = 1,
          axis.textcolor = "black")

fig_beta_overall <- plot_model(beta_overall, type = "pred",
                               title = "Predicted values of relative abundance for all data") 

ggsave(fig_beta_overall$time_period, filename = "figs/fig_beta_relAbundance_overall.png", width = 9, height = 6, device = png(), units = "in", dpi = 300)
dev.off()
```

## Forest birds
```{r}
forest_birds <- rel_abun_trait %>%
  filter(Habitat.type == "Forest")
  
beta_forest <- betareg(relative_abundance ~ time_period, data = forest_birds)
summary(beta_forest)

# Call:
# betareg(formula = relative_abundance ~ time_period, data = forest_birds)
# 
# Standardized weighted residuals 2:
#     Min      1Q  Median      3Q     Max 
# -1.7684 -0.5982  0.0193  0.6095  1.9556 
# 
# Coefficients (mean model with logit link):
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)          -4.39464    0.10831 -40.575  < 2e-16 ***
# time_period1900-1950  0.04366    0.13935   0.313  0.75402    
# time_period2021      -0.43329    0.14874  -2.913  0.00358 ** 
# 
# Phi coefficients (precision model with identity link):
#       Estimate Std. Error z value Pr(>|z|)    
# (phi)    89.36      10.65   8.393   <2e-16 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
# 
# Type of estimator: ML (maximum likelihood)
# Log-likelihood: 639.5 on 4 Df
# Pseudo R-squared: 0.08616
# Number of iterations: 50 (BFGS) + 2 (Fisher scoring) 

# plot predicted model estimates
set_theme(base = theme_bw(),
          theme.font = "Century Gothic",
          axis.title.size = 1.2,
          axis.textsize = 1,
          axis.textcolor = "black")

fig_beta_forest <- plot_model(beta_forest, type = "pred",
                               title = "Predicted values of relative abundance for forest birds") 

ggsave(fig_beta_forest$time_period, filename = "figs/fig_beta_relAbundance_forestBirds.png", width = 9, height = 6, device = png(), units = "in", dpi = 300)
dev.off()
```

## Grassland birds
```{r}
grassland_birds <- rel_abun_trait %>%
  filter(Habitat.type == "Grassland")
  
beta_grassland <- betareg(relative_abundance ~ time_period, data = grassland_birds)
summary(beta_grassland)

# Call:
# betareg(formula = relative_abundance ~ time_period, data = grassland_birds)
# 
# Standardized weighted residuals 2:
#     Min      1Q  Median      3Q     Max 
# -2.5784 -0.6403 -0.2810  0.7729  1.8508 
# 
# Coefficients (mean model with logit link):
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)           -4.2185     0.2275 -18.543  < 2e-16 ***
# time_period1900-1950  -0.2321     0.3110  -0.747 0.455361    
# time_period2021       -1.3221     0.3673  -3.599 0.000319 ***
# 
# Phi coefficients (precision model with identity link):
#       Estimate Std. Error z value Pr(>|z|)    
# (phi)    100.7       28.8   3.496 0.000472 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
# 
# Type of estimator: ML (maximum likelihood)
# Log-likelihood:   129 on 4 Df
# Pseudo R-squared: 0.5336
# Number of iterations: 121 (BFGS) + 3 (Fisher scoring) 

# plot predicted model estimates
set_theme(base = theme_bw(),
          theme.font = "Century Gothic",
          axis.title.size = 1.2,
          axis.textsize = 1,
          axis.textcolor = "black")

fig_beta_grassland <- plot_model(beta_grassland, type = "pred",title = "Predicted values of relative abundance for grassland birds") 

ggsave(fig_beta_grassland$time_period, filename = "figs/fig_beta_relAbundance_grasslandBirds.png", width = 9, height = 6, device = png(), units = "in", dpi = 300)
dev.off()
```

## Generalist birds
```{r}
generalist_birds <- rel_abun_trait %>%
  filter(Habitat.type == "Generalist")
  
beta_generalist <- betareg(relative_abundance ~ time_period, data = generalist_birds)
summary(beta_generalist)

# Call:
# betareg(formula = relative_abundance ~ time_period, data = generalist_birds)
# 
# Standardized weighted residuals 2:
#     Min      1Q  Median      3Q     Max 
# -2.2639 -0.3514  0.0518  0.5865  2.3521 
# 
# Coefficients (mean model with logit link):
#                      Estimate Std. Error z value Pr(>|z|)    
# (Intercept)           -4.6184     0.2046 -22.569   <2e-16 ***
# time_period1900-1950   0.2061     0.2517   0.819    0.413    
# time_period2021        0.2033     0.2517   0.807    0.419    
# 
# Phi coefficients (precision model with identity link):
#       Estimate Std. Error z value Pr(>|z|)    
# (phi)    80.23      16.27   4.929 8.25e-07 ***
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1 
# 
# Type of estimator: ML (maximum likelihood)
# Log-likelihood: 220.5 on 4 Df
# Pseudo R-squared: 0.02063
# Number of iterations: 59 (BFGS) + 2 (Fisher scoring) 

# plot predicted model estimates
set_theme(base = theme_bw(),
          theme.font = "Century Gothic",
          axis.title.size = 1.2,
          axis.textsize = 1,
          axis.textcolor = "black")

fig_beta_generalist <- plot_model(beta_generalist, type = "pred",title = "Predicted values of relative abundance for Generalist birds") 

ggsave(fig_beta_generalist$time_period, filename = "figs/fig_beta_relAbundance_generalistBirds.png", width = 9, height = 6, device = png(), units = "in", dpi = 300)
dev.off()
```

## Creating a combined figure for the above three models
```{r}
combined_plot <- wrap_plots(fig_beta_forest$time_period, fig_beta_grassland$time_period,fig_beta_generalist$time_period, ncol = 2)

ggsave(combined_plot, filename = "figs/fig_beta_relAbundance_combinedPlot.png", width = 12, height = 10, device = png(), units = "in", dpi = 300)
dev.off()
```
