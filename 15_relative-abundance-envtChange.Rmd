---
editor_options: 
  chunk_output_type: console
---

# Species relative abundance as a function of environmental changes

In this script, we will model changes in relative abundance as a function of environmental changes across the historical resurvey locations (environmental changes are calculated as differences in values of a predictor between modern vs. historical time period)

## Load necessary libraries
```{r}
# load libs
library(sf)
library(readr)
library(dplyr)
library(terra)
library(tidyr)
library(mapview)
library(sjPlot)
library(glmmTMB)
library(ggplot2)
library(effects)
library(lme4)
library(DHARMa)
library(ggpubr)
library(bbmle)
library(betareg)
library(extrafont)
library(ggeffects)
library(sjPlot)

# function to z-transform data
scale_z <- function(x){
  (x - mean(x, na.rm=TRUE))/sd(x, na.rm=TRUE)
}
```

## Load processed land cover rasters
```{r}
lc_1848 <- terra::rast("results/processed-rasters/1848.tif")
lc_2018 <- terra::rast("results/processed-rasters/2018reclassified.tif")
```

## Load modern resurvey locations
```{r}
# load sites
sites <- read_csv("data/list-of-resurvey-locations.csv")
sites <- distinct(sites, modern_site_code, historical_site_code, longitude, latitude)
sites <- sites[-c(1:50),]
```

## Create spatial data within a 250m buffer for each site (trying 1000m)
```{r}
# make spatial data from sites, with a 250m buffer
sites_sf = st_as_sf(
  sites, coords = c("longitude", "latitude"),
  crs = 4326
) |> 
  st_transform(32643) |> 
  st_buffer(500)
```

## Extract land cover data across locations from the 1848 and the 2018 rasters
```{r}
# first, we will polygonize the rasters 
vect1848 <- as.polygons(lc_1848)
vect2018 <- as.polygons(lc_2018)

# get intersection of the historical resurvey sites with 1848 and 2018 vector data
lc_sites <- lapply(
  list(vect1848, vect2018), function(x) {
    st_intersection(st_as_sf(x), sites_sf)
  }
)

# calculate total area for each lc type for sites based on historical site code for each time period
lc_sites <- lapply(lc_sites, function(df) {
  df |> 
    mutate(
      area = as.numeric(st_area(df))
    ) |> 
    st_drop_geometry() |> 
    group_by(modern_site_code, name) |> 
    summarise(total_area = sum(area))
})

# add year and merge
lc_sites <- Map(
  lc_sites, c(1848, 2018),
  f = function(df, y) {
    df$year = y
    df
  }
) |> 
  bind_rows()
```

## Calculate change in land cover between time periods

For this calculation, we use a simple formulation which essentially replicates the calculation of NDVI = (value in time period Y - value in time period X)/(value in time period Y + value in time period X). This gives us a value ranging between -1 to 1, with higher negative values implying loss in time period Y and positive values imply gain in time period Y. We also simply calculated the difference in total area of that land cover type between two time periods.
```{r}
# get lc change sites
lc_change_dat <- lc_sites |> 
  pivot_wider(
    id_cols = c("modern_site_code", "name"),
    names_from = c("year"),
    values_from = "total_area",
    values_fn = mean
  ) |> 
  rename(
    year_1848 = `1848`,
    year_2018 = `2018`
  ) %>%
  left_join(., sites_sf, by="modern_site_code") %>%
  replace(is.na(.), 0) %>%
  mutate("lc_percent_change" = (year_2018 - year_1848)/(year_2018 + year_1848)) %>%#  -negative values implies loss and + positive values implies gain
  mutate("lc_area_change" = (year_2018 - year_1848))

# save as is for further processing
write_csv(
  lc_change_dat, file = "results/lc_change.csv"
)
```

## Calculate change in climate values at sampling sites
```{r}
# load climate data
raster_temp = list.files("data/climate/", pattern = "t_mean", full.names = T) |> 
  lapply(rast)

raster_rain = list.files("data/climate/", pattern = "ppt", full.names = T) |> 
  lapply(rast)

# get difference between first and last files
climate_change = lapply(
  list(raster_temp, raster_rain),
  function(le) {
    lapply(le, function(le2) {
      le2[[length(names(le2))]] - le2[[1]]
    })
  }
) |> 
  Reduce(f = c) # convert to single list

# get raster names
climate_change_names = lapply(climate_change, function(ra) {
  lapply(ra, function(r) {
    r |> names() |> stringr::str_extract("(.*?)(?=_\\d+)")
  })
}) |> unlist()

# get mean change within 250m buffer of resurvey locs
climate_change_sites = lapply(
  climate_change, function(ra) {
    terra::extract(
      ra, 
      y = terra::vect(
        sites_sf |> 
          st_transform(4326)
      ), fun = mean
    )  
  }
)

# combine all metrics
climate_change_sites = Reduce(f = left_join, x = climate_change_sites)

# attach to sampling sites
sites <- mutate(sites, ID = seq(nrow(sites)))
clim_change_dat <- left_join(sites, climate_change_sites)

# save site data
write_csv(
  clim_change_dat, file = "results/climate_change.csv"
)
```

## Load species relative abundance
```{r}
relAbun <- read.csv("results/species-relative-abundance-siteLevel.csv")
```

## Load species trait data
```{r}
trait_dat <- read.csv("data/species-trait-dat.csv")
```

## Is there a significant association between change in relative abundance and change in an environmental covariate across time periods?

We will first prepare the dataframes necessary for running linear mixed models.
```{r}
## preparing the relative abundance dataframe for a mixed effects model
names(relAbun) <- c("scientific_name","historical_site_code","year","relAbundance")

pivot_1850 <- relAbun %>%
  filter(year == 1850) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

pivot_2021 <- relAbun %>%
  filter(year == 2021) %>%
  pivot_wider(., names_from = "year", values_from = "relAbundance")

# calculate difference between modern and historical time periods
# positive value implies gain in relative abundance in 2021 compared to 1850, while negative value implies loss in relative abundance in 2021 compared to 1850

relAbun_wide <- full_join(pivot_1850, pivot_2021, by=c("scientific_name","historical_site_code")) %>%
  mutate("relAbunChange" = `2021` - `1850`)

## prepare the land cover data
## calculating mean change at the level of the historical site code
## prior to this calculation, we observed a gain in forest cover across most of the resurvey locations except for OTCM1 (loss = -0.79)

lc_meanChange <- lc_change_dat %>%
  group_by(historical_site_code, name) %>%
  summarise(lc_percent_change = mean(lc_percent_change)) 

## make land cover data wider
lc_glmm <- lc_meanChange %>%
  pivot_wider(id_cols = historical_site_code, 
              names_from = name, 
              values_from = lc_percent_change)

## join all three dataframes together
## prepare climate change data
clim_change_glmm <- clim_change_dat %>%
  dplyr::select(historical_site_code, t_mean_dry_2010, t_mean_rainy_2010, ppt_dry_2010, ppt_rainy_2010) %>%
  group_by(historical_site_code) %>%
  summarise(across(everything(), mean))

## dataframe for glmm
glmm_data <- left_join(relAbun_wide,lc_glmm,
                       by = "historical_site_code") %>%
  left_join(., clim_change_glmm, by = "historical_site_code") %>%
  as.data.frame() %>%
  replace(is.na(.), 0)

## scale the climate data
glmm_data <- glmm_data %>%
  mutate(t_mean_dry_2010_z = scale_z(t_mean_dry_2010)) %>%
  mutate(t_mean_rainy_2010_z = scale_z(t_mean_rainy_2010)) %>%
  mutate(ppt_dry_2010_z = scale_z(ppt_dry_2010)) %>%
  mutate(ppt_rainy_2010_z = scale_z(ppt_rainy_2010)) 
```

## Test for correlations between covariates
```{r}
library(psych)
for_corr <- glmm_data[,c(6:11,16:19)] %>%
  distinct()

pairs.panels(for_corr)

# correlative analyses suggests that t_mean_dry2010 is highly correlated with t_mean_rainy2010 and ppt_mean_rainy2010
# for future analyses, we will only include t_mean_dry2010 and ppt_mean_dry2010
```

## Running generalized linear mixed effect models for specific habitat affiliations
```{r}
glmm_habitat <- left_join(glmm_data, trait_dat, by = "scientific_name") 

## grassland birds
glmm_grassland <-  glmm_habitat %>%
  filter(Habitat.type == "Grassland")

m1 <- glmmTMB(relAbunChange ~ shola_grassland + settlements + shola_forest + water_bodies + agriculture + (1|scientific_name),
              ziformula = ~0,
              family=gaussian(),
               data = glmm_grassland)

summary(m1)

# Family: gaussian  ( identity )
# Formula:          relAbunChange ~ shola_grassland + settlements + shola_forest +  
#     water_bodies + agriculture + (1 | scientific_name)
# Data: glmm_grassland
# 
#      AIC      BIC   logLik deviance df.resid 
#  -1565.4  -1538.3    790.7  -1581.4      212 
# 
# Random effects:
# 
# Conditional model:
#  Groups          Name        Variance  Std.Dev.
#  scientific_name (Intercept) 2.499e-06 0.001581
#  Residual                    4.254e-05 0.006522
# Number of obs: 220, groups:  scientific_name, 11
# 
# Dispersion estimate for gaussian family (sigma^2): 4.25e-05 
# 
# Conditional model:
#                   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)     -0.0166732  0.0048069  -3.469 0.000523 ***
# shola_grassland -0.0089736  0.0042003  -2.136 0.032647 *  
# settlements      0.0005654  0.0014657   0.386 0.699660    
# shola_forest     0.0043892  0.0020064   2.188 0.028702 *  
# water_bodies     0.0026814  0.0012272   2.185 0.028891 *  
# agriculture      0.0007097  0.0009270   0.766 0.443890    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

plot_model(m1, type = "std")

grass_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z +
                         (1|scientific_name),
                      data = glmm_grassland,
                      family = gaussian())

summary(grass_clim)

#  Family: gaussian  ( identity )
# Formula:          relAbunChange ~ t_mean_dry_2010_z + (1 | scientific_name)
# Data: glmm_grassland
# 
#      AIC      BIC   logLik deviance df.resid 
#  -1569.8  -1556.2    788.9  -1577.8      216 
# 
# Random effects:
# 
# Conditional model:
#  Groups          Name        Variance  Std.Dev.
#  scientific_name (Intercept) 2.462e-06 0.001569
#  Residual                    4.329e-05 0.006579
# Number of obs: 220, groups:  scientific_name, 11
# 
# Dispersion estimate for gaussian family (sigma^2): 4.33e-05 
# 
# Conditional model:
#                     Estimate Std. Error z value Pr(>|z|)    
# (Intercept)       -0.0060539  0.0006485  -9.335  < 2e-16 ***
# t_mean_dry_2010_z -0.0011852  0.0004437  -2.671  0.00756 ** 
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

plot_model(grass_clim, type = "std")

## forest birds
glmm_forest <-  glmm_habitat %>%
  filter(Habitat.type == "Forest")

forest_lc <- glmmTMB(relAbunChange ~ shola_forest + settlements + agriculture + shola_grassland + water_bodies + 
                 (1|scientific_name),
               data = glmm_forest,
               family = gaussian())


forest_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                      data = glmm_forest,
                      family = gaussian())

summary(forest_lc) # marginal negative effect of grasslands
summary(forest_clim) # no significance

plot_model(forest_lc, type = "std")

## generalist birds
glmm_generalist <-  glmm_habitat %>%
  filter(Habitat.type == "Generalist")

generalist_lc <- glmmTMB(relAbunChange ~ shola_forest + 
                            shola_grassland + settlements 
                          + agriculture +
                 (1|scientific_name),
               data = glmm_generalist,
               family = gaussian())


generalist_clim <- glmmTMB(relAbunChange ~ t_mean_dry_2010_z + 
                        ppt_dry_2010_z + (1|scientific_name),
                      data = glmm_generalist,
                      family = gaussian())

summary(generalist_lc) # positive association with increasing grasslands?
summary(generalist_clim)

plot_model(generalist_lc, type = "std")
```







